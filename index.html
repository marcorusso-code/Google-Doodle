<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prenota un Appuntamento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Main Container -->
    <div id="main-container" class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-2xl transform transition-transform duration-300">

        <!-- Header -->
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">Crea Appuntamenti Condivisibili</h1>
        <p class="text-center text-gray-600 mb-8">Gestisci gli appuntamenti di gruppo direttamente dal tuo Google Calendar.</p>

        <!-- Google Sign-In Button -->
        <div id="auth-buttons" class="flex justify-center">
            <button id="authorize_button" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-full shadow-lg hover:bg-blue-700 transition duration-300 transform hover:scale-105">
                Accedi con Google
            </button>
        </div>

        <!-- Main App Content (hidden initially) -->
        <div id="app-content" class="hidden">
            <!-- Loading Indicator -->
            <div id="loading" class="hidden text-center text-gray-500 mt-4">
                <div class="animate-spin inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full"></div>
                <p class="mt-2">Caricamento...</p>
            </div>

            <!-- Calendar Owner View -->
            <div id="owner-view" class="space-y-6">
                <!-- Calendar Selector -->
                <div>
                    <label for="calendar-select" class="block text-lg font-medium text-gray-700 mb-2">Seleziona Calendario</label>
                    <select id="calendar-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        <option>Caricamento calendari...</option>
                    </select>
                </div>
    
                <!-- Create Appointment Form -->
                <div class="bg-gray-50 p-6 rounded-lg shadow-inner">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Crea un Nuovo Slot Appuntamento</h2>
                    <form id="create-form" class="space-y-4">
                        <div>
                            <label for="event-title" class="block text-sm font-medium text-gray-700">Titolo Appuntamento</label>
                            <input type="text" id="event-title" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="start-time" class="block text-sm font-medium text-gray-700">Inizio</label>
                                <input type="datetime-local" id="start-time" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="end-time" class="block text-sm font-medium text-gray-700">Fine</label>
                                <input type="datetime-local" id="end-time" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <div>
                            <label for="capacity" class="block text-sm font-medium text-gray-700">Numero di Slot Disponibili</label>
                            <input type="number" id="capacity" value="1" min="1" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <button type="submit" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-full shadow-md hover:bg-green-700 transition duration-300">
                            Crea Slot
                        </button>
                    </form>
                </div>
    
                <!-- Existing Appointments List -->
                <div class="bg-gray-50 p-6 rounded-lg shadow-inner">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">I Miei Slot Appuntamento</h2>
                    <div id="appointments-list" class="space-y-4">
                        <p class="text-gray-500 text-sm">Nessun appuntamento creato. Seleziona un calendario e creane uno.</p>
                    </div>
                </div>
            </div>

            <!-- Booking Guest View (hidden initially) -->
            <div id="guest-view" class="hidden">
                <div class="bg-gray-50 p-6 rounded-lg shadow-inner">
                    <h2 id="booking-title" class="text-2xl font-bold text-gray-700 mb-4"></h2>
                    <p id="booking-details" class="text-gray-600 mb-4"></p>
                    <div id="booking-status" class="text-sm font-medium p-2 rounded-md mb-4 hidden"></div>
                    <form id="booking-form" class="space-y-4">
                        <div>
                            <label for="guest-name" class="block text-sm font-medium text-gray-700">Il tuo Nome</label>
                            <input type="text" id="guest-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-full shadow-md hover:bg-indigo-700 transition duration-300">
                            Prenota ora
                        </button>
                    </form>
                </div>
            </div>

            <!-- Message Box -->
            <div id="message-box" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4">
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                    <h3 id="message-title" class="text-lg font-bold text-gray-800 mb-2"></h3>
                    <p id="message-content" class="text-gray-600 mb-4"></p>
                    <div class="flex justify-end">
                        <button id="message-ok" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition duration-300">
                            OK
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        /*
         * IMPORTANTE: E' NECESSARIO INSERIRE LE TUE CREDENZIALI API QUI!
         * Questo codice utilizza dei valori segnaposto che non funzionano.
         * Per ottenere le tue credenziali:
         *
         * 1. Vai alla Console API di Google: 
         * https://console.cloud.google.com/
         *
         * 2. Crea un nuovo progetto.
         *
         * 3. Abilita l'API di Google Calendar per il tuo progetto.
         *
         * 4. Vai alla sezione "Credenziali" e crea un'ID client OAuth 2.0.
         * Assicurati di configurare l'URI di reindirizzamento per `http://localhost`.
         *
         * 5. Crea una "Chiave API".
         *
         * 6. Sostituisci i valori segnaposto qui sotto con le tue credenziali.
         */
        const CLIENT_ID = '1062046351666-cnbek28i76lgqbte85ssre7a3qui9gl1.apps.googleusercontent.com'; // Sostituisci questo
        const API_KEY = 'AIzaSyASCrBXFbsyZdk-tLbAVWRwce4lGaZ5XjU'; // Sostituisci questo
        // Scopi richiesti per l'API di Google Calendar
        const SCOPES = 'https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/calendar.readonly';

        // Variabili globali
        let gapiInited = false;
        let gisInited = false;
        let tokenClient;
        let selectedCalendarId;
        let calendars = [];

        // Elementi DOM
        const authButtons = document.getElementById('auth-buttons');
        const authorizeButton = document.getElementById('authorize_button');
        const appContent = document.getElementById('app-content');
        const loadingDiv = document.getElementById('loading');
        const calendarSelect = document.getElementById('calendar-select');
        const createForm = document.getElementById('create-form');
        const appointmentsList = document.getElementById('appointments-list');
        const ownerView = document.getElementById('owner-view');
        const guestView = document.getElementById('guest-view');
        const bookingTitle = document.getElementById('booking-title');
        const bookingDetails = document.getElementById('booking-details');
        const bookingStatusDiv = document.getElementById('booking-status');
        const bookingForm = document.getElementById('booking-form');
        const messageBox = document.getElementById('message-box');
        const messageTitle = document.getElementById('message-title');
        const messageContent = document.getElementById('message-content');
        const messageOkButton = document.getElementById('message-ok');

        // Funzione per mostrare un messaggio personalizzato
        function showMessage(title, message) {
            messageTitle.textContent = title;
            messageContent.textContent = message;
            messageBox.classList.remove('hidden');
            messageBox.classList.add('flex');
        }

        // Gestore del click sul pulsante OK del messaggio
        messageOkButton.addEventListener('click', () => {
            messageBox.classList.add('hidden');
            messageBox.classList.remove('flex');
        });

        // Caricamento della libreria gapi
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        // Inizializzazione del client gapi
        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'],
                });
                gapiInited = true;
                maybeEnableButtons();
            } catch (err) {
                console.error("Errore nel caricamento del client GAPI:", err);
                showMessage("Errore di Autenticazione", "Le credenziali API non sono valide. Sostituisci YOUR_CLIENT_ID e YOUR_API_KEY nel codice con le tue credenziali personali.");
            }
        }

        // Caricamento della libreria gis
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // Sostituita dalla chiamata di handleAuthResult
            });
            gisInited = true;
            maybeEnableButtons();
        }

        // Controlla se le librerie sono pronte e abilita il pulsante di autorizzazione
        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                authorizeButton.onclick = handleAuthClick;
                authButtons.classList.remove('hidden');
            }
        }

        // Gestisce il flusso di autorizzazione
        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                authButtons.classList.add('hidden');
                appContent.classList.remove('hidden');
                loadingDiv.classList.remove('hidden');
                await listCalendars();
                loadingDiv.classList.add('hidden');
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        // Funzione per listare i calendari dell'utente
        async function listCalendars() {
            try {
                const response = await gapi.client.calendar.calendarList.list();
                calendars = response.result.items;
                renderCalendars();
                if (calendars.length > 0) {
                    selectedCalendarId = calendars[0].id;
                    listAppointmentSlots(selectedCalendarId);
                }
            } catch (err) {
                console.error("Errore nel listare i calendari:", err);
                showMessage("Errore", "Impossibile caricare i calendari. Controlla l'accesso alle autorizzazioni.");
            }
        }

        // Renderizza il dropdown dei calendari
        function renderCalendars() {
            calendarSelect.innerHTML = '';
            calendars.forEach(calendar => {
                const option = document.createElement('option');
                option.value = calendar.id;
                option.textContent = calendar.summary;
                calendarSelect.appendChild(option);
            });
        }

        // Gestisce la selezione di un calendario
        calendarSelect.addEventListener('change', (e) => {
            selectedCalendarId = e.target.value;
            listAppointmentSlots(selectedCalendarId);
        });

        // Gestisce l'invio del form di creazione appuntamento
        createForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('event-title').value;
            const start = document.getElementById('start-time').value;
            const end = document.getElementById('end-time').value;
            const capacity = document.getElementById('capacity').value;

            if (!selectedCalendarId) {
                showMessage("Errore", "Seleziona un calendario prima di creare un appuntamento.");
                return;
            }

            try {
                const event = {
                    summary: title,
                    start: { dateTime: new Date(start).toISOString() },
                    end: { dateTime: new Date(end).toISOString() },
                    extendedProperties: {
                        shared: {
                            capacity: capacity,
                            bookings: JSON.stringify([]),
                        }
                    },
                    description: `Slot Appuntamento con capacità: ${capacity}`,
                };

                const response = await gapi.client.calendar.events.insert({
                    calendarId: selectedCalendarId,
                    resource: event,
                });

                console.log('Appuntamento creato:', response.result);
                showMessage("Successo", `Slot appuntamento "${response.result.summary}" creato con successo!`);
                createForm.reset();
                listAppointmentSlots(selectedCalendarId); // Aggiorna la lista
            } catch (err) {
                console.error("Errore nella creazione dell'appuntamento:", err);
                showMessage("Errore", "Si è verificato un errore durante la creazione dell'appuntamento.");
            }
        });

        // Funzione per listare gli slot di appuntamento
        async function listAppointmentSlots(calendarId) {
            try {
                const response = await gapi.client.calendar.events.list({
                    calendarId: calendarId,
                    timeMin: (new Date()).toISOString(),
                    showDeleted: false,
                    singleEvents: true,
                    q: 'Slot Appuntamento', // Filtra per la descrizione
                    maxResults: 10,
                });
                renderAppointmentSlots(response.result.items);
            } catch (err) {
                console.error("Errore nel listare gli appuntamenti:", err);
                appointmentsList.innerHTML = '<p class="text-red-500 text-sm">Errore nel caricamento degli appuntamenti.</p>';
            }
        }

        // Renderizza la lista degli appuntamenti
        function renderAppointmentSlots(events) {
            appointmentsList.innerHTML = '';
            if (events.length === 0) {
                appointmentsList.innerHTML = '<p class="text-gray-500 text-sm">Nessun appuntamento futuro trovato per questo calendario.</p>';
                return;
            }
            events.forEach(event => {
                const capacity = event.extendedProperties?.shared?.capacity || 1;
                const bookings = JSON.parse(event.extendedProperties?.shared?.bookings || '[]');
                const bookedCount = bookings.length;

                const startDate = new Date(event.start.dateTime);
                const endDate = new Date(event.end.dateTime);
                const formatter = new Intl.DateTimeFormat('it-IT', { dateStyle: 'full', timeStyle: 'short' });

                const eventElement = document.createElement('div');
                eventElement.className = 'bg-white p-4 rounded-lg shadow border border-gray-200 flex flex-col sm:flex-row items-center justify-between';
                eventElement.innerHTML = `
                    <div class="mb-2 sm:mb-0 sm:mr-4 flex-grow">
                        <h3 class="font-bold text-gray-800">${event.summary}</h3>
                        <p class="text-sm text-gray-600">${formatter.format(startDate)} - ${formatter.format(endDate)}</p>
                        <p class="text-sm text-gray-500">Prenotazioni: ${bookedCount} / ${capacity}</p>
                    </div>
                    <div class="flex-shrink-0">
                        <button class="copy-link-btn bg-purple-600 text-white text-xs font-semibold py-2 px-4 rounded-full shadow hover:bg-purple-700 transition duration-300" data-event-id="${event.id}" data-calendar-id="${event.organizer.email}">
                            Copia Link
                        </button>
                    </div>
                `;
                appointmentsList.appendChild(eventElement);
            });

            // Aggiungi event listener ai nuovi pulsanti
            document.querySelectorAll('.copy-link-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const eventId = e.target.dataset.eventId;
                    const calendarId = e.target.dataset.calendarId;
                    const bookingLink = `${window.location.origin}${window.location.pathname}?bookingId=${eventId}&calendarId=${calendarId}&isBooking=true`;
                    copyToClipboard(bookingLink);
                });
            });
        }

        // Funzione per copiare il link negli appunti
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showMessage("Link Copiato!", "Il link per la prenotazione è stato copiato negli appunti.");
        }

        // Gestione della vista per l'ospite
        async function handleGuestView(eventId, calendarId) {
            ownerView.classList.add('hidden');
            guestView.classList.remove('hidden');
            loadingDiv.classList.remove('hidden');

            try {
                const response = await gapi.client.calendar.events.get({
                    calendarId: calendarId,
                    eventId: eventId
                });
                const event = response.result;
                if (!event) {
                    showMessage("Errore", "L'appuntamento non esiste più.");
                    loadingDiv.classList.add('hidden');
                    return;
                }

                const capacity = event.extendedProperties?.shared?.capacity || 1;
                const bookings = JSON.parse(event.extendedProperties?.shared?.bookings || '[]');
                const bookedCount = bookings.length;

                bookingTitle.textContent = event.summary;
                const startDate = new Date(event.start.dateTime);
                const endDate = new Date(event.end.dateTime);
                const formatter = new Intl.DateTimeFormat('it-IT', { dateStyle: 'full', timeStyle: 'short' });
                bookingDetails.textContent = `Orario: ${formatter.format(startDate)} - ${formatter.format(endDate)}`;
                
                updateBookingStatus(bookedCount, capacity);
                
                bookingForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const guestName = document.getElementById('guest-name').value;
                    bookAppointment(eventId, calendarId, guestName, event);
                });

            } catch (err) {
                console.error("Errore nel caricare l'evento di prenotazione:", err);
                showMessage("Errore", "Impossibile caricare i dettagli dell'appuntamento.");
            } finally {
                loadingDiv.classList.add('hidden');
            }
        }

        // Aggiorna lo stato della prenotazione
        function updateBookingStatus(bookedCount, capacity) {
            bookingStatusDiv.classList.remove('hidden');
            if (bookedCount >= capacity) {
                bookingStatusDiv.textContent = 'Slot Appuntamento al completo!';
                bookingStatusDiv.className = 'text-center font-bold text-sm bg-red-100 text-red-700 p-3 rounded-md mb-4';
                bookingForm.querySelector('button').disabled = true;
                bookingForm.querySelector('button').textContent = 'Non Disponibile';
            } else {
                const remaining = capacity - bookedCount;
                bookingStatusDiv.textContent = `Slot disponibili: ${remaining} / ${capacity}`;
                bookingStatusDiv.className = 'text-center font-bold text-sm bg-green-100 text-green-700 p-3 rounded-md mb-4';
                bookingForm.querySelector('button').disabled = false;
                bookingForm.querySelector('button').textContent = 'Prenota ora';
            }
        }

        // Funzione per prenotare un appuntamento
        async function bookAppointment(eventId, calendarId, guestName, event) {
            let bookings = JSON.parse(event.extendedProperties?.shared?.bookings || '[]');
            const capacity = event.extendedProperties?.shared?.capacity || 1;

            if (bookings.length >= capacity) {
                showMessage("Errore", "Questo slot è già al completo.");
                return;
            }

            bookings.push({ name: guestName, timestamp: new Date().toISOString() });

            try {
                const updatedEvent = {
                    extendedProperties: {
                        shared: {
                            capacity: capacity.toString(),
                            bookings: JSON.stringify(bookings),
                        }
                    }
                };
                
                // Aggiorna la descrizione con le prenotazioni
                const newDescription = `Slot Appuntamento con capacità: ${capacity}\n\nPartecipanti:\n${bookings.map(b => `- ${b.name}`).join('\n')}`;
                updatedEvent.description = newDescription;

                const response = await gapi.client.calendar.events.patch({
                    calendarId: calendarId,
                    eventId: eventId,
                    resource: updatedEvent,
                });
                
                const bookedCount = bookings.length;
                updateBookingStatus(bookedCount, capacity);
                document.getElementById('guest-name').value = '';
                showMessage("Successo", `Grazie per aver prenotato, ${guestName}!`);
                
            } catch (err) {
                console.error("Errore nella prenotazione:", err);
                showMessage("Errore", "Si è verificato un errore durante la prenotazione.");
            }
        }

        // Inizializzazione quando il DOM è pronto
        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            const bookingId = params.get('bookingId');
            const calendarId = params.get('calendarId');
            const isBooking = params.get('isBooking');

            // Avvia il caricamento delle librerie
            gapi.load('client', gapiLoaded);
            window.gapiLoaded = gapiLoaded;
            
            const script = document.createElement('script');
            script.src = 'https://accounts.google.com/gsi/client';
            script.onload = gisLoaded;
            document.head.appendChild(script);

            // Controlla se la pagina è in modalità di prenotazione
            if (isBooking) {
                if (bookingId && calendarId) {
                    ownerView.classList.add('hidden');
                    guestView.classList.remove('hidden');
                    handleGuestView(bookingId, calendarId);
                } else {
                    showMessage("Link Incompleto", "Il link di prenotazione è incompleto. Assicurati di copiare e condividere l'intero URL generato dall'applicazione.");
                    ownerView.classList.remove('hidden');
                    guestView.classList.add('hidden');
                }
            } else {
                // Mostra la vista del proprietario
                ownerView.classList.remove('hidden');
                guestView.classList.add('hidden');
            }
        };

    </script>
</body>
</html>
